---
title: "2021 Residency selection tool"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      bootswatch: cosmo
      base_font: 
        google: Open Sans
      heading_font:
        google: Open Sans
    orientation: rows
    vertical_layout: fill
    navbar:
      - { icon: "fa-linkedin", href: "https://www.linkedin.com/in/justin-leder-3401904b/",align: right}
      - { icon: "fa-envelope", href: "mailto:justin.leder.2@gmail.com",align: right}
      - { icon: "fa-github", href: "https://github.com/homebase3",align: right}
      - { icon: "fa-coffee", href: "https://www.buymeacoffee.com/justinleder",align: right}
---

<style>
.html-widget.gauge {
  height: 100%; /*or try sth like 320px instead of 100%, whatever you prefer*/
}

.html-widget.gauge svg {
  height: 100%; /*or try sth like 320px instead of 100%, whatever you prefer*/
  margin-top: 0px;
  margin-bottom: 0px;
}

.btn-1 {
  background-color: #1F2041;
  color: #fff;
}
.btn-2 {
  background-color: #4B3F72;
  color: #fff;
}
.btn-3 {
  background-color: #119DA4;
  color: #fff;
}
.btn-4 {
  background-color: #19647E;
  color: #fff;
}

hr {
  border-top: none !important;
}

button {
  margin-bottom: 5px;
}

</style>

---

```{r setup, context="setup", include=FALSE}
# import packages
library(dplyr)
library(tidyr)
library(magrittr)
library(readr)
library(stringr)
library(plotly)
library(reticulate)
library(flexdashboard)
library(shiny)
library(reactable)
library(DT)
library(shiny)
library(shinyWidgets)
library(bslib)
library(thematic)
library(rintrojs)
library(here)
library(kableExtra)

# load functions and objects
base<- getwd()
models_loc <- here("models")
for (obj in list.files(paste0(here("objects"),"/"))) {
  base::load(paste0(here("objects",obj)))
}

source("core/functions.R")
# bslib::bs_themer()
```

```{python import_models, context="setup", include = FALSE}
import turicreate as tc
models = dict()
for key in r.dat_list.keys():
  models[key] = tc.load_model(r.models_loc + '/' + key + '/')
```

```{r, context="setup"}
filters <- read_csv("config/filters.csv")
filter_groups <- unique(filters$Class) %>% .[!is.na(.)]
filters %<>%
  drop_na() %>%
  arrange(Colname)
classes <- lapply(imputed_df_list[[1]], class)
```

```{r, context="server"}
UI_helper_func <- function(var) {
  if (!is.null(classes[[var]])) {
      if (as.character(classes[[var]]) == "numeric") {
        min <- floor(min(combined_df_list[[input$specialty]][[var]], na.rm = T))
        max <- ceiling(max(combined_df_list[[input$specialty]][[var]], na.rm = T))
        sliderInput(var,var,min,max,c(min,max),round=T)
    } else {
        vals <- unique(as.character(combined_df_list[[input$specialty]][[var]]))
        pickerInput(var,var, choices=vals,selected = vals, multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10, `selected-text-format` = "count > 3"))
    }
  }
}

renderGroupUI <- function(group) {
  renderUI({
    filters %>%
      filter(Class %in% group) %>%
      dplyr::select(Colname) %>%
      .[[1]] -> vars_
    lapply(vars_, UI_helper_func)
  })
}
```

Applicant competitiveness
=======================

```{r, context="server"}

steps1 <- data.frame(element = c("#specialty-selectized","#section-inputs","#section-overall-score","#step1Gauge", ".navbar"),
                     intro = c("To get started, select your desired specialty.",
                               "Then enter information about your step scores. Please note that these values are not logged or saved, and no one will have access to them other than you.",
                               "Once you've made your entries, you can see an assessment of your competitiveness in that specialty here versus matched applicants in the prior few years. This aggregates your scores on each individual components based on their relative importance accroding to program director surveys in your chosen specialty.",
                               "Your competitiveness for the individual components can also be found below. For example, this is your score based on your step 1 score alone",
                               "Once you're done, click 'Select programs' in the navbar to move to the next section. Give it a few seconds to load :)"))

steps2 <-data.frame(element = c("#table", ".navbar ","#table","#table","#table","#section-row-2",".btn","#section-selectbar","#section-selectbar","#section-selectbar","#section-selectbar","#UIbuttons"),
                    intro = c("First off, you'll see a list of (nearly) every program in your specialty. Programs are bucketted into \"Reach\", \"Target\", and \"Safer\" based on (1) your competitiveness in the specialty and (2) our assessment of the program based on applicant competitiveness, research quality, teaching quality, and patient outcomes. The initial order of the programs is based on this rank list, with the top program at the top.",
                              "You can find more detail on how your specialty was ranked by clicking \"More info on specialty ranking\" in the Navbar.",
                              "For each program, you can quickly see its details as well as links to all major relevant sites, including the Program website itself, Freida, AAMC, and Doximity where available.",
                              "To see additional information collected on an individual program, click the plus sign at the right of the table.",
                              "To select a program, simply click on the row in the table and it will highlight.",
                              "As you make your selections, the boxes at the top of the page will keep a tally of how many programs you've selected and at what level of competitiveness to help you craft a full, well-balanced program portfolio",
                              "If you would like help finding programs, click the \"Make recommendations and resort\" button. This will make recommendations based on a machine learning algorithm that tries to find similarities between your current selections and the other remaining programs. Once this loads, your current selections will be at the top, then the programs will be listed in the order of recommendation. I.e. the top recommended program will be first after your current selections.",
                              "You can also filter programs based on the menus contained below. These include all the traditional filters (e.g. Geography), but also some unique ones, including weather, cost of living, county health characteristics, and county divserity. We hope you find these useful.",
                              "To access the filters, click on an arrow to open the respective menu",
                              "Then set your filters, the table with automatically adjust, and don't worry, your prior selections will be saved, even if the filter removes them",
                              "You can continue this way until you find all your programs",
                              "Once you are satisfied with your list, click \"Download selections\" to dowload a csv file with all of the information about your chosen programs. Please note that the app will not save your selections ion, so make sure to do this to keep a record of your selection. Otherwise, you'll be starting from scratch the next time you open the app."))

observeEvent(input$tour1,{
  introjs(session,options = list(steps=steps1))
})

observeEvent(input$tour2,{
  introjs(session,options = list(steps=steps2))
})
```

```{r, context="server"}
output$introJShelper <- renderUI({
  introjsUI()
})
```

Inputs2 {.sidebar}
------
```{r}
uiOutput("introJShelper")
actionButton("tour1","Take tour of this page",icon("paper-plane"))
selectInput(
  "specialty",
  "Specialty",
  spec_dat$Specialty,
  selected =spec_dat$Specialty[1],
  multiple = FALSE,
  selectize = TRUE
)
numericInput(
  "step1",
  "Step 1 score",
  220,
  min = 190,
  max = 270,
  step = 1,
)
numericInput(
  "step2",
  "Step 2 score",
  220,
  min = 190,
  max = 270,
  step = 1,
)
numericInput(
  "research",
  "Number of research experiences",
  0,
  min = 0,
  max = 20,
  step = 1,
)
numericInput(
  "publications",
  "Number of abstracts, presentations, and publications",
  0,
  min = 0,
  max = 20,
  step = 1,
)
numericInput(
  "work",
  "Number of work experiences",
  0,
  min = 0,
  max = 20,
  step = 1,
)
numericInput(
  "volunteer",
  "Number of volunteer experiences",
  0,
  min = 0,
  max = 20,
  step = 1,
)
```

Row {data-height=300}
----

### Overall score
```{r, context="server"}
output$valuebox <- renderValueBox({
  c(input$step1, input$step2, input$research, input$publications, input$work, input$volunteer) %>%
    score_overall(., input$specialty, spec_dat,dists,PD_Survey_weights) %>%
    `*`(100) -> score
  col <- if_else(score >= 50, "#3fb618", if_else(score >= 20, "#ff7518", "#ff0039"))
  score %>%
    round(.) %>%
    scales::ordinal(.) %>%
    tags$p(., style = "font-size: 200%; color: #fff") %>%
    valueBox(., caption = tags$p(paste0("percentile overall in ",input$specialty),style = "font-size: 150%; color: #fff"), icon = 'fa-star', color = col, href = NULL)
})
```

```{r, context="render"}
valueBoxOutput("valuebox")
```

Row {data-height=300}
----

### Step 1 score

```{r, context="server"}
output$step1Gauge<- renderGauge({
  score_step1(input$step1,input$specialty, spec_dat,dists)%>%
    `*`(100) %>%
    round(.) %>%
    gauge(.,0,100, label = "Percentile", sectors = gaugeSectors(success = c(50,100),
                                                                warning = c(20,50),
                                                                danger = c(0,20),
                                                                colors = c("success", "warning","danger")))
})
```

```{r, context="render"}
gaugeOutput("step1Gauge")
```

### Step 2 score

```{r, context="server"}
output$step2Gauge <- renderGauge({
  score_step2(input$step2,input$specialty, spec_dat,dists)%>%
    `*`(100) %>%
    round(.) %>%
    gauge(.,0,100, label = "Percentile", sectors = gaugeSectors(success = c(67,100),
                                                                warning = c(33,67),
                                                                danger = c(0,33),
                                                                colors = c("success", "warning","danger")))
})
```

```{r, context="render"}
gaugeOutput("step2Gauge")
```

Row {data-height=400}
----

### Number of research experiences

```{r, context="server"}
output$researchGauge <- renderGauge({
  score_research(input$research,input$specialty, spec_dat,dists)%>%
    `*`(100) %>%
    round(.) %>%
    gauge(.,0,100, label = "Percentile", sectors = gaugeSectors(success = c(67,100),
                                                                warning = c(33,67),
                                                                danger = c(0,33),
                                                                colors = c("success", "warning","danger")))
})
```

```{r, context="render"}
gaugeOutput("researchGauge")
```

### Number of abstracts, presentations, and publications

```{r, context="server"}
output$publicationsGauge <- renderGauge({
  score_publications(input$publications,input$specialty, spec_dat,dists)%>%
    `*`(100) %>%
    round(.) %>%
    gauge(.,0,100, label = "Percentile", sectors = gaugeSectors(success = c(67,100),
                                                                warning = c(33,67),
                                                                danger = c(0,33),
                                                                colors = c("success", "warning","danger")))
})
```

```{r, context="render"}
gaugeOutput("publicationsGauge")
```

### Number of work experiences

```{r, context="server"}

output$workGauge <- renderGauge({
  score_work(input$work,input$specialty, spec_dat,dists)%>%
    `*`(100) %>%
    round(.) %>%
    gauge(.,0,100, label = "Percentile", sectors = gaugeSectors(success = c(67,100),
                                                                warning = c(33,67),
                                                                danger = c(0,33),
                                                                colors = c("success", "warning","danger")))
})
```

```{r, context="render"}
gaugeOutput("workGauge")
```

### Number of volunteer experiences

```{r, context="server"}
output$volunteerGauge <- renderGauge({
  score_volunteer(input$volunteer,input$specialty, spec_dat,dists)%>%
    `*`(100) %>%
    round(.) %>%
    gauge(.,0,100, label = "Percentile", sectors = gaugeSectors(success = c(67,100),
                                                                warning = c(33,67),
                                                                danger = c(0,33),
                                                                colors = c("success", "warning",
                                                                           "danger")))
})
```

```{r, context="render"}
gaugeOutput("volunteerGauge")
```

Select programs
================

Input {.sidebar data-width=300 id="selectbar"}
--------------------

```{r, context="server"}
output$UIbuttons <- renderUI({
  list(
  actionButton("button","Make recommendations and resort"),
  actionButton("tour2","Take tour of this page",icon("paper-plane")),
  downloadButton("downloadData", "Download selections")
  )
})
```

```{r, context="render"}
uiOutput("UIbuttons")
```

<details>

<summary>Program basics</summary>
```{r, context="render", results="asis"}
observeEvent(input$specialty,{
  filters %>%
  filter(Class %in% "Program basics") %>%
    dplyr::select(Colname) %>%
    .[[1]] -> vars_
  lis_ <- lapply(vars_, UI_helper_func)
  for (el in lis_) {
    print(el)
  }
})

# for (el in as.character(lis_)) {
#   shiny::tagList(.)
# }
```
</details>
<details>
<summary>Program basics</summary>
```{r, context='render'}
pickerInput('Participates in ERAS','Participates in ERAS',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))
pickerInput('Participates in the NRMP Main Match','Participates in the NRMP Main Match',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))
pickerInput('Program setting','Program setting',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))
pickerInput('Residency program name','Residency program name',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))
pickerInput('Status','Status',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))

```
</details>

<details>
<summary>Geography</summary>
```{r, context='render'}
pickerInput('City','City',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))
pickerInput('Metro Area Name','Metro Area Name',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))
pickerInput('State','State',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))

```
</details>

<details>
<summary>Resident demographics</summary>
```{r, context='render'}
sliderInput('Percentage of completed residents with non-academic U.S. practice career plans','Percentage of completed residents with non-academic U.S. practice career plans',0,1, c(0,1),round=T)
sliderInput('Percentage of completed residents with other career plans','Percentage of completed residents with other career plans',0,1, c(0,1),round=T)
sliderInput('Percentage of completed residents with plans to continue training in another program','Percentage of completed residents with plans to continue training in another program',0,1, c(0,1),round=T)
sliderInput('Percentage of completed residents with plans to obtain a full-time or part-time academic position','Percentage of completed residents with plans to obtain a full-time or part-time academic position',0,1, c(0,1),round=T)
sliderInput('Percentage of residents who were non-US-citizen IMGs','Percentage of residents who were non-US-citizen IMGs',0,1, c(0,1),round=T)
sliderInput('Percentage of residents who were US DO graduates','Percentage of residents who were US DO graduates',0,1, c(0,1),round=T)
sliderInput('Percentage of residents who were US MD graduates','Percentage of residents who were US MD graduates',0,1, c(0,1),round=T)
sliderInput('Percentage of residents who were US-citizen IMGs','Percentage of residents who were US-citizen IMGs',0,1, c(0,1),round=T)

```
</details>

<details>
<summary>Accreditation</summary>
```{r, context='render'}
pickerInput('Osteopathic Recognition','Osteopathic Recognition',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))
pickerInput('Program accreditation status','Program accreditation status',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))

```
</details>

<details>
<summary>Program size</summary>
```{r, context='render'}
sliderInput('# of advanced positions filled by this program in the 2021 NRMP Main Match','# of advanced positions filled by this program in the 2021 NRMP Main Match',0,1, c(0,1),round=T)
sliderInput('# of advanced positions offered by this program in the 2021 NRMP Main Match','# of advanced positions offered by this program in the 2021 NRMP Main Match',0,1, c(0,1),round=T)
sliderInput('# of applications submitted to this program in 2021','# of applications submitted to this program in 2021',0,1, c(0,1),round=T)
sliderInput('# of categorical positions filled by this program in the 2021 NRMP Main Match','# of categorical positions filled by this program in the 2021 NRMP Main Match',0,1, c(0,1),round=T)
sliderInput('# of categorical positions offered by this program in the 2021 NRMP Main Match','# of categorical positions offered by this program in the 2021 NRMP Main Match',0,1, c(0,1),round=T)
sliderInput('# of positions filled by this program in the 2021 NRMP Main Match','# of positions filled by this program in the 2021 NRMP Main Match',0,1, c(0,1),round=T)
sliderInput('# of positions offered by this program in the 2021 NRMP Main Match','# of positions offered by this program in the 2021 NRMP Main Match',0,1, c(0,1),round=T)
sliderInput('# Residents on Duty Year 1','# Residents on Duty Year 1',0,1, c(0,1),round=T)
sliderInput('% of applicants interviewed by the program in 2020','% of applicants interviewed by the program in 2020',0,1, c(0,1),round=T)
sliderInput('Total # Residents on Duty','Total # Residents on Duty',0,1, c(0,1),round=T)

```
</details>

<details>
<summary>Applicant competitiveness</summary>
```{r, context='render'}
sliderInput('Average number of peer-reviewed publications among matched applicants','Average number of peer-reviewed publications among matched applicants',0,1, c(0,1),round=T)
sliderInput('Average number of research experiences among matched applicants','Average number of research experiences among matched applicants',0,1, c(0,1),round=T)
sliderInput('Average number of volunteer experiences among matched applicants','Average number of volunteer experiences among matched applicants',0,1, c(0,1),round=T)
sliderInput('Average number of work experiences among matched applicants','Average number of work experiences among matched applicants',0,1, c(0,1),round=T)
sliderInput('Percentage of matched applicants who were members of Alpha Omega Alpha (at the time of application)','Percentage of matched applicants who were members of Alpha Omega Alpha (at the time of application)',0,1, c(0,1),round=T)
sliderInput('Percentage of matched applicants who were members of Gold Humanism Honor Society (at the time of application)','Percentage of matched applicants who were members of Gold Humanism Honor Society (at the time of application)',0,1, c(0,1),round=T)
pickerInput('Range of average COMLEX Level 1 score of current residents','Range of average COMLEX Level 1 score of current residents',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))
pickerInput('Range of average USMLE Step 1 score of current residents','Range of average USMLE Step 1 score of current residents',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))

```
</details>

<details>
<summary>International student considerations</summary>
```{r, context='render'}
pickerInput('Program consider applicants with F-1 Visa (OPT 1st year)?','Program consider applicants with F-1 Visa (OPT 1st year)?',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))
pickerInput('Program consider applicants with H-1B visa?','Program consider applicants with H-1B visa?',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))
pickerInput('Program consider applicants with J-1 visa?','Program consider applicants with J-1 visa?',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))

```
</details>

<details>
<summary>Program experience</summary>
```{r, context='render'}
sliderInput('% of training spent in year 1 in ambulatory nonhospital community-based settings','% of training spent in year 1 in ambulatory nonhospital community-based settings',0,1, c(0,1),round=T)
sliderInput('% of training spent in year 1 in hospital outpatient clinics','% of training spent in year 1 in hospital outpatient clinics',0,1, c(0,1),round=T)
sliderInput('Average hours/week in year one of program spent in structured didactic activities (e.g., lectures, conferences)','Average hours/week in year one of program spent in structured didactic activities (e.g., lectures, conferences)',0,1, c(0,1),round=T)
sliderInput('Average hours/week in year one that resident works (excluding beeper call)','Average hours/week in year one that resident works (excluding beeper call)',0,1, c(0,1),round=T)
sliderInput('Maximum consecutive hours resident is allowed to work in year one (excluding beeper call)','Maximum consecutive hours resident is allowed to work in year one (excluding beeper call)',0,1, c(0,1),round=T)
pickerInput('Program allows residents (beyond PGY1) to moonlight?','Program allows residents (beyond PGY1) to moonlight?',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))
pickerInput('Program curriculum includes a dedicated research rotation','Program curriculum includes a dedicated research rotation',choices= c(0, 1), multiple = T, options=list(`liveSearch` = T, `actions-box` = TRUE,size = 10,`selected-text-format` = 'count > 3'))

```
</details>

<details>
<summary>Research</summary>
```{r, context='render'}
sliderInput('2019 NIH specialty funding','2019 NIH specialty funding',0,1, c(0,1),round=T)
sliderInput('2019 NIH total funding','2019 NIH total funding',0,1, c(0,1),round=T)

```
</details>

<details>
<summary>Teaching</summary>
```{r, context='render'}
sliderInput('Family medicine board pass rate','Family medicine board pass rate',0,1, c(0,1),round=T)
sliderInput('Internal medicine board pass rate','Internal medicine board pass rate',0,1, c(0,1),round=T)
sliderInput('Pediatrics board pass rate','Pediatrics board pass rate',0,1, c(0,1),round=T)
sliderInput('Surgery board pass rate','Surgery board pass rate',0,1, c(0,1),round=T)

```
</details>

<details>
<summary>Weather</summary>
```{r, context='render'}
sliderInput('% days above 90F','% days above 90F',0,1, c(0,1),round=T)
sliderInput('% days below freezing','% days below freezing',0,1, c(0,1),round=T)
sliderInput('% days with precipitation','% days with precipitation',0,1, c(0,1),round=T)
sliderInput('Annual snowfall','Annual snowfall',0,1, c(0,1),round=T)
sliderInput('Mean % sunny','Mean % sunny',0,1, c(0,1),round=T)

```
</details>

<details>
<summary>Cost of living</summary>
```{r, context='render'}
sliderInput('Cost of Living Index','Cost of Living Index',0,1, c(0,1),round=T)

```
</details>

<details>
<summary>County health characteristics</summary>
```{r, context='render'}
sliderInput('Access to Care (percentile)','Access to Care (percentile)',0,1, c(0,1),round=T)
sliderInput('Air and Water Quality (percentile)','Air and Water Quality (percentile)',0,1, c(0,1),round=T)
sliderInput('Alcohol and Drug Use (percentile)','Alcohol and Drug Use (percentile)',0,1, c(0,1),round=T)
sliderInput('Clinical care (percentile)','Clinical care (percentile)',0,1, c(0,1),round=T)
sliderInput('Community Safety (percentile)','Community Safety (percentile)',0,1, c(0,1),round=T)
sliderInput('Diet and Exercise (percentile)','Diet and Exercise (percentile)',0,1, c(0,1),round=T)
sliderInput('Education (percentile)','Education (percentile)',0,1, c(0,1),round=T)
sliderInput('Employment (percentile)','Employment (percentile)',0,1, c(0,1),round=T)
sliderInput('Family and Social Support (percentile)','Family and Social Support (percentile)',0,1, c(0,1),round=T)
sliderInput('Health behaviors (percentile)','Health behaviors (percentile)',0,1, c(0,1),round=T)
sliderInput('Health factors (percentile)','Health factors (percentile)',0,1, c(0,1),round=T)
sliderInput('Health outcomes (percentile)','Health outcomes (percentile)',0,1, c(0,1),round=T)
sliderInput('Housing and Transit (percentile)','Housing and Transit (percentile)',0,1, c(0,1),round=T)
sliderInput('Income (percentile)','Income (percentile)',0,1, c(0,1),round=T)
sliderInput('Income Ratio','Income Ratio',0,1, c(0,1),round=T)
sliderInput('Income Ratio (percentile)','Income Ratio (percentile)',0,1, c(0,1),round=T)
sliderInput('Length of Life (percentile)','Length of Life (percentile)',0,1, c(0,1),round=T)
sliderInput('Physical environment (percentile)','Physical environment (percentile)',0,1, c(0,1),round=T)
sliderInput('Quality of Care (percentile)','Quality of Care (percentile)',0,1, c(0,1),round=T)
sliderInput('Quality of Life (percentile)','Quality of Life (percentile)',0,1, c(0,1),round=T)
sliderInput('Sexual Activity (percentile)','Sexual Activity (percentile)',0,1, c(0,1),round=T)
sliderInput('Social & economic factors (percentile)','Social & economic factors (percentile)',0,1, c(0,1),round=T)
sliderInput('Tobacco Use (percentile)','Tobacco Use (percentile)',0,1, c(0,1),round=T)

```
</details>

<details>
<summary>County demographics</summary>
```{r, context='render'}
sliderInput('% 65 and Over','% 65 and Over',0,1, c(0,1),round=T)
sliderInput('% American Indian & Alaska Native','% American Indian & Alaska Native',0,1, c(0,1),round=T)
sliderInput('% Asian','% Asian',0,1, c(0,1),round=T)
sliderInput('% Black','% Black',0,1, c(0,1),round=T)
sliderInput('% Female','% Female',0,1, c(0,1),round=T)
sliderInput('% Hispanic','% Hispanic',0,1, c(0,1),round=T)
sliderInput('% Less Than 18 Years of Age','% Less Than 18 Years of Age',0,1, c(0,1),round=T)
sliderInput('% Native Hawaiian/Other Pacific Islander','% Native Hawaiian/Other Pacific Islander',0,1, c(0,1),round=T)
sliderInput('% Non-Hispanic White','% Non-Hispanic White',0,1, c(0,1),round=T)
sliderInput('% Rural','% Rural',0,1, c(0,1),round=T)
sliderInput('Population','Population',0,1, c(0,1),round=T)

```
</details>

<details>
<summary>Hospital outcomes</summary>
```{r, context='render'}
sliderInput('Hospital overall rating','Hospital overall rating',0,1, c(0,1),round=T)
sliderInput('MORT Better %','MORT Better %',0,1, c(0,1),round=T)
sliderInput('MORT Worse %','MORT Worse %',0,1, c(0,1),round=T)
sliderInput('READM Better %','READM Better %',0,1, c(0,1),round=T)
sliderInput('READM Worse %','READM Worse %',0,1, c(0,1),round=T)
sliderInput('Safety Better %','Safety Better %',0,1, c(0,1),round=T)
sliderInput('Safety Worse %','Safety Worse %',0,1, c(0,1),round=T)

```
</details>

Row {data-height=50}
-----

```{r server_logic, context="server", include = F}
# immediately update dummy inputs
observeEvent(input$specialty, {
  mins = list()
  maxs = list()
  vals = list()
  for (group in filter_groups) {
    for (var in group) {
      if (!is.null(classes[[var]])) {
        if (as.character(classes[[var]]) == "numeric") {
          mins[[var]] <- floor(min(combined_df_list[[input$specialty]][[var]], na.rm = T))
          maxs[[var]] <- ceiling(max(combined_df_list[[input$specialty]][[var]], na.rm = T))
        } else {
          vals[[var]] <- unique(as.character(combined_df_list[[input$specialty]][[var]]))
        }
      }
    }
  }
  # copy in code generated by from UI_update_helper. Need to rerun only if variable names change
  updatePickerInput(session, inputId ='Participates in ERAS', choices=vals[['Participates in ERAS']],selected = vals[['Participates in ERAS']])
  updatePickerInput(session, inputId ='Participates in the NRMP Main Match', choices=vals[['Participates in the NRMP Main Match']],selected = vals[['Participates in the NRMP Main Match']])
  updatePickerInput(session, inputId ='Program setting', choices=vals[['Program setting']],selected = vals[['Program setting']])
  updatePickerInput(session, inputId ='Residency program name', choices=vals[['Residency program name']],selected = vals[['Residency program name']])
  updatePickerInput(session, inputId ='Status', choices=vals[['Status']],selected = vals[['Status']])
  updatePickerInput(session, inputId ='City', choices=vals[['City']],selected = vals[['City']])
  updatePickerInput(session, inputId ='Metro Area Name', choices=vals[['Metro Area Name']],selected = vals[['Metro Area Name']])
  updatePickerInput(session, inputId ='State', choices=vals[['State']],selected = vals[['State']])
  updateSliderInput(session,inputId='Percentage of completed residents with non-academic U.S. practice career plans', min=mins[['Percentage of completed residents with non-academic U.S. practice career plans']], max= maxs[['Percentage of completed residents with non-academic U.S. practice career plans']], value=c(mins[['Percentage of completed residents with non-academic U.S. practice career plans']],maxs[['Percentage of completed residents with non-academic U.S. practice career plans']]))
  updateSliderInput(session,inputId='Percentage of completed residents with other career plans', min=mins[['Percentage of completed residents with other career plans']], max= maxs[['Percentage of completed residents with other career plans']], value=c(mins[['Percentage of completed residents with other career plans']],maxs[['Percentage of completed residents with other career plans']]))
  updateSliderInput(session,inputId='Percentage of completed residents with plans to continue training in another program', min=mins[['Percentage of completed residents with plans to continue training in another program']], max= maxs[['Percentage of completed residents with plans to continue training in another program']], value=c(mins[['Percentage of completed residents with plans to continue training in another program']],maxs[['Percentage of completed residents with plans to continue training in another program']]))
  updateSliderInput(session,inputId='Percentage of completed residents with plans to obtain a full-time or part-time academic position', min=mins[['Percentage of completed residents with plans to obtain a full-time or part-time academic position']], max= maxs[['Percentage of completed residents with plans to obtain a full-time or part-time academic position']], value=c(mins[['Percentage of completed residents with plans to obtain a full-time or part-time academic position']],maxs[['Percentage of completed residents with plans to obtain a full-time or part-time academic position']]))
  updateSliderInput(session,inputId='Percentage of residents who were non-US-citizen IMGs', min=mins[['Percentage of residents who were non-US-citizen IMGs']], max= maxs[['Percentage of residents who were non-US-citizen IMGs']], value=c(mins[['Percentage of residents who were non-US-citizen IMGs']],maxs[['Percentage of residents who were non-US-citizen IMGs']]))
  updateSliderInput(session,inputId='Percentage of residents who were US DO graduates', min=mins[['Percentage of residents who were US DO graduates']], max= maxs[['Percentage of residents who were US DO graduates']], value=c(mins[['Percentage of residents who were US DO graduates']],maxs[['Percentage of residents who were US DO graduates']]))
  updateSliderInput(session,inputId='Percentage of residents who were US MD graduates', min=mins[['Percentage of residents who were US MD graduates']], max= maxs[['Percentage of residents who were US MD graduates']], value=c(mins[['Percentage of residents who were US MD graduates']],maxs[['Percentage of residents who were US MD graduates']]))
  updateSliderInput(session,inputId='Percentage of residents who were US-citizen IMGs', min=mins[['Percentage of residents who were US-citizen IMGs']], max= maxs[['Percentage of residents who were US-citizen IMGs']], value=c(mins[['Percentage of residents who were US-citizen IMGs']],maxs[['Percentage of residents who were US-citizen IMGs']]))
  updatePickerInput(session, inputId ='Osteopathic Recognition', choices=vals[['Osteopathic Recognition']],selected = vals[['Osteopathic Recognition']])
  updatePickerInput(session, inputId ='Program accreditation status', choices=vals[['Program accreditation status']],selected = vals[['Program accreditation status']])
  updateSliderInput(session,inputId='# of advanced positions filled by this program in the 2021 NRMP Main Match', min=mins[['# of advanced positions filled by this program in the 2021 NRMP Main Match']], max= maxs[['# of advanced positions filled by this program in the 2021 NRMP Main Match']], value=c(mins[['# of advanced positions filled by this program in the 2021 NRMP Main Match']],maxs[['# of advanced positions filled by this program in the 2021 NRMP Main Match']]))
  updateSliderInput(session,inputId='# of advanced positions offered by this program in the 2021 NRMP Main Match', min=mins[['# of advanced positions offered by this program in the 2021 NRMP Main Match']], max= maxs[['# of advanced positions offered by this program in the 2021 NRMP Main Match']], value=c(mins[['# of advanced positions offered by this program in the 2021 NRMP Main Match']],maxs[['# of advanced positions offered by this program in the 2021 NRMP Main Match']]))
  updateSliderInput(session,inputId='# of applications submitted to this program in 2021', min=mins[['# of applications submitted to this program in 2021']], max= maxs[['# of applications submitted to this program in 2021']], value=c(mins[['# of applications submitted to this program in 2021']],maxs[['# of applications submitted to this program in 2021']]))
  updateSliderInput(session,inputId='# of categorical positions filled by this program in the 2021 NRMP Main Match', min=mins[['# of categorical positions filled by this program in the 2021 NRMP Main Match']], max= maxs[['# of categorical positions filled by this program in the 2021 NRMP Main Match']], value=c(mins[['# of categorical positions filled by this program in the 2021 NRMP Main Match']],maxs[['# of categorical positions filled by this program in the 2021 NRMP Main Match']]))
  updateSliderInput(session,inputId='# of categorical positions offered by this program in the 2021 NRMP Main Match', min=mins[['# of categorical positions offered by this program in the 2021 NRMP Main Match']], max= maxs[['# of categorical positions offered by this program in the 2021 NRMP Main Match']], value=c(mins[['# of categorical positions offered by this program in the 2021 NRMP Main Match']],maxs[['# of categorical positions offered by this program in the 2021 NRMP Main Match']]))
  updateSliderInput(session,inputId='# of positions filled by this program in the 2021 NRMP Main Match', min=mins[['# of positions filled by this program in the 2021 NRMP Main Match']], max= maxs[['# of positions filled by this program in the 2021 NRMP Main Match']], value=c(mins[['# of positions filled by this program in the 2021 NRMP Main Match']],maxs[['# of positions filled by this program in the 2021 NRMP Main Match']]))
  updateSliderInput(session,inputId='# of positions offered by this program in the 2021 NRMP Main Match', min=mins[['# of positions offered by this program in the 2021 NRMP Main Match']], max= maxs[['# of positions offered by this program in the 2021 NRMP Main Match']], value=c(mins[['# of positions offered by this program in the 2021 NRMP Main Match']],maxs[['# of positions offered by this program in the 2021 NRMP Main Match']]))
  updateSliderInput(session,inputId='# Residents on Duty Year 1', min=mins[['# Residents on Duty Year 1']], max= maxs[['# Residents on Duty Year 1']], value=c(mins[['# Residents on Duty Year 1']],maxs[['# Residents on Duty Year 1']]))
  updateSliderInput(session,inputId='% of applicants interviewed by the program in 2020', min=mins[['% of applicants interviewed by the program in 2020']], max= maxs[['% of applicants interviewed by the program in 2020']], value=c(mins[['% of applicants interviewed by the program in 2020']],maxs[['% of applicants interviewed by the program in 2020']]))
  updateSliderInput(session,inputId='Total # Residents on Duty', min=mins[['Total # Residents on Duty']], max= maxs[['Total # Residents on Duty']], value=c(mins[['Total # Residents on Duty']],maxs[['Total # Residents on Duty']]))
  updateSliderInput(session,inputId='Average number of peer-reviewed publications among matched applicants', min=mins[['Average number of peer-reviewed publications among matched applicants']], max= maxs[['Average number of peer-reviewed publications among matched applicants']], value=c(mins[['Average number of peer-reviewed publications among matched applicants']],maxs[['Average number of peer-reviewed publications among matched applicants']]))
  updateSliderInput(session,inputId='Average number of research experiences among matched applicants', min=mins[['Average number of research experiences among matched applicants']], max= maxs[['Average number of research experiences among matched applicants']], value=c(mins[['Average number of research experiences among matched applicants']],maxs[['Average number of research experiences among matched applicants']]))
  updateSliderInput(session,inputId='Average number of volunteer experiences among matched applicants', min=mins[['Average number of volunteer experiences among matched applicants']], max= maxs[['Average number of volunteer experiences among matched applicants']], value=c(mins[['Average number of volunteer experiences among matched applicants']],maxs[['Average number of volunteer experiences among matched applicants']]))
  updateSliderInput(session,inputId='Average number of work experiences among matched applicants', min=mins[['Average number of work experiences among matched applicants']], max= maxs[['Average number of work experiences among matched applicants']], value=c(mins[['Average number of work experiences among matched applicants']],maxs[['Average number of work experiences among matched applicants']]))
  updateSliderInput(session,inputId='Percentage of matched applicants who were members of Alpha Omega Alpha (at the time of application)', min=mins[['Percentage of matched applicants who were members of Alpha Omega Alpha (at the time of application)']], max= maxs[['Percentage of matched applicants who were members of Alpha Omega Alpha (at the time of application)']], value=c(mins[['Percentage of matched applicants who were members of Alpha Omega Alpha (at the time of application)']],maxs[['Percentage of matched applicants who were members of Alpha Omega Alpha (at the time of application)']]))
  updateSliderInput(session,inputId='Percentage of matched applicants who were members of Gold Humanism Honor Society (at the time of application)', min=mins[['Percentage of matched applicants who were members of Gold Humanism Honor Society (at the time of application)']], max= maxs[['Percentage of matched applicants who were members of Gold Humanism Honor Society (at the time of application)']], value=c(mins[['Percentage of matched applicants who were members of Gold Humanism Honor Society (at the time of application)']],maxs[['Percentage of matched applicants who were members of Gold Humanism Honor Society (at the time of application)']]))
  updatePickerInput(session, inputId ='Range of average COMLEX Level 1 score of current residents', choices=vals[['Range of average COMLEX Level 1 score of current residents']],selected = vals[['Range of average COMLEX Level 1 score of current residents']])
  updatePickerInput(session, inputId ='Range of average USMLE Step 1 score of current residents', choices=vals[['Range of average USMLE Step 1 score of current residents']],selected = vals[['Range of average USMLE Step 1 score of current residents']])
  updatePickerInput(session, inputId ='Program consider applicants with F-1 Visa (OPT 1st year)?', choices=vals[['Program consider applicants with F-1 Visa (OPT 1st year)?']],selected = vals[['Program consider applicants with F-1 Visa (OPT 1st year)?']])
  updatePickerInput(session, inputId ='Program consider applicants with H-1B visa?', choices=vals[['Program consider applicants with H-1B visa?']],selected = vals[['Program consider applicants with H-1B visa?']])
  updatePickerInput(session, inputId ='Program consider applicants with J-1 visa?', choices=vals[['Program consider applicants with J-1 visa?']],selected = vals[['Program consider applicants with J-1 visa?']])
  updateSliderInput(session,inputId='% of training spent in year 1 in ambulatory nonhospital community-based settings', min=mins[['% of training spent in year 1 in ambulatory nonhospital community-based settings']], max= maxs[['% of training spent in year 1 in ambulatory nonhospital community-based settings']], value=c(mins[['% of training spent in year 1 in ambulatory nonhospital community-based settings']],maxs[['% of training spent in year 1 in ambulatory nonhospital community-based settings']]))
  updateSliderInput(session,inputId='% of training spent in year 1 in hospital outpatient clinics', min=mins[['% of training spent in year 1 in hospital outpatient clinics']], max= maxs[['% of training spent in year 1 in hospital outpatient clinics']], value=c(mins[['% of training spent in year 1 in hospital outpatient clinics']],maxs[['% of training spent in year 1 in hospital outpatient clinics']]))
  updateSliderInput(session,inputId='Average hours/week in year one of program spent in structured didactic activities (e.g., lectures, conferences)', min=mins[['Average hours/week in year one of program spent in structured didactic activities (e.g., lectures, conferences)']], max= maxs[['Average hours/week in year one of program spent in structured didactic activities (e.g., lectures, conferences)']], value=c(mins[['Average hours/week in year one of program spent in structured didactic activities (e.g., lectures, conferences)']],maxs[['Average hours/week in year one of program spent in structured didactic activities (e.g., lectures, conferences)']]))
  updateSliderInput(session,inputId='Average hours/week in year one that resident works (excluding beeper call)', min=mins[['Average hours/week in year one that resident works (excluding beeper call)']], max= maxs[['Average hours/week in year one that resident works (excluding beeper call)']], value=c(mins[['Average hours/week in year one that resident works (excluding beeper call)']],maxs[['Average hours/week in year one that resident works (excluding beeper call)']]))
  updateSliderInput(session,inputId='Maximum consecutive hours resident is allowed to work in year one (excluding beeper call)', min=mins[['Maximum consecutive hours resident is allowed to work in year one (excluding beeper call)']], max= maxs[['Maximum consecutive hours resident is allowed to work in year one (excluding beeper call)']], value=c(mins[['Maximum consecutive hours resident is allowed to work in year one (excluding beeper call)']],maxs[['Maximum consecutive hours resident is allowed to work in year one (excluding beeper call)']]))
  updatePickerInput(session, inputId ='Program allows residents (beyond PGY1) to moonlight?', choices=vals[['Program allows residents (beyond PGY1) to moonlight?']],selected = vals[['Program allows residents (beyond PGY1) to moonlight?']])
  updatePickerInput(session, inputId ='Program curriculum includes a dedicated research rotation', choices=vals[['Program curriculum includes a dedicated research rotation']],selected = vals[['Program curriculum includes a dedicated research rotation']])
  updateSliderInput(session,inputId='2019 NIH specialty funding', min=mins[['2019 NIH specialty funding']], max= maxs[['2019 NIH specialty funding']], value=c(mins[['2019 NIH specialty funding']],maxs[['2019 NIH specialty funding']]))
  updateSliderInput(session,inputId='2019 NIH total funding', min=mins[['2019 NIH total funding']], max= maxs[['2019 NIH total funding']], value=c(mins[['2019 NIH total funding']],maxs[['2019 NIH total funding']]))
  updateSliderInput(session,inputId='Family medicine board pass rate', min=mins[['Family medicine board pass rate']], max= maxs[['Family medicine board pass rate']], value=c(mins[['Family medicine board pass rate']],maxs[['Family medicine board pass rate']]))
  updateSliderInput(session,inputId='Internal medicine board pass rate', min=mins[['Internal medicine board pass rate']], max= maxs[['Internal medicine board pass rate']], value=c(mins[['Internal medicine board pass rate']],maxs[['Internal medicine board pass rate']]))
  updateSliderInput(session,inputId='Pediatrics board pass rate', min=mins[['Pediatrics board pass rate']], max= maxs[['Pediatrics board pass rate']], value=c(mins[['Pediatrics board pass rate']],maxs[['Pediatrics board pass rate']]))
  updateSliderInput(session,inputId='Surgery board pass rate', min=mins[['Surgery board pass rate']], max= maxs[['Surgery board pass rate']], value=c(mins[['Surgery board pass rate']],maxs[['Surgery board pass rate']]))
  updateSliderInput(session,inputId='% days above 90F', min=mins[['% days above 90F']], max= maxs[['% days above 90F']], value=c(mins[['% days above 90F']],maxs[['% days above 90F']]))
  updateSliderInput(session,inputId='% days below freezing', min=mins[['% days below freezing']], max= maxs[['% days below freezing']], value=c(mins[['% days below freezing']],maxs[['% days below freezing']]))
  updateSliderInput(session,inputId='% days with precipitation', min=mins[['% days with precipitation']], max= maxs[['% days with precipitation']], value=c(mins[['% days with precipitation']],maxs[['% days with precipitation']]))
  updateSliderInput(session,inputId='Annual snowfall', min=mins[['Annual snowfall']], max= maxs[['Annual snowfall']], value=c(mins[['Annual snowfall']],maxs[['Annual snowfall']]))
  updateSliderInput(session,inputId='Mean % sunny', min=mins[['Mean % sunny']], max= maxs[['Mean % sunny']], value=c(mins[['Mean % sunny']],maxs[['Mean % sunny']]))
  updateSliderInput(session,inputId='Cost of Living Index', min=mins[['Cost of Living Index']], max= maxs[['Cost of Living Index']], value=c(mins[['Cost of Living Index']],maxs[['Cost of Living Index']]))
  updateSliderInput(session,inputId='Access to Care (percentile)', min=mins[['Access to Care (percentile)']], max= maxs[['Access to Care (percentile)']], value=c(mins[['Access to Care (percentile)']],maxs[['Access to Care (percentile)']]))
  updateSliderInput(session,inputId='Air and Water Quality (percentile)', min=mins[['Air and Water Quality (percentile)']], max= maxs[['Air and Water Quality (percentile)']], value=c(mins[['Air and Water Quality (percentile)']],maxs[['Air and Water Quality (percentile)']]))
  updateSliderInput(session,inputId='Alcohol and Drug Use (percentile)', min=mins[['Alcohol and Drug Use (percentile)']], max= maxs[['Alcohol and Drug Use (percentile)']], value=c(mins[['Alcohol and Drug Use (percentile)']],maxs[['Alcohol and Drug Use (percentile)']]))
  updateSliderInput(session,inputId='Clinical care (percentile)', min=mins[['Clinical care (percentile)']], max= maxs[['Clinical care (percentile)']], value=c(mins[['Clinical care (percentile)']],maxs[['Clinical care (percentile)']]))
  updateSliderInput(session,inputId='Community Safety (percentile)', min=mins[['Community Safety (percentile)']], max= maxs[['Community Safety (percentile)']], value=c(mins[['Community Safety (percentile)']],maxs[['Community Safety (percentile)']]))
  updateSliderInput(session,inputId='Diet and Exercise (percentile)', min=mins[['Diet and Exercise (percentile)']], max= maxs[['Diet and Exercise (percentile)']], value=c(mins[['Diet and Exercise (percentile)']],maxs[['Diet and Exercise (percentile)']]))
  updateSliderInput(session,inputId='Education (percentile)', min=mins[['Education (percentile)']], max= maxs[['Education (percentile)']], value=c(mins[['Education (percentile)']],maxs[['Education (percentile)']]))
  updateSliderInput(session,inputId='Employment (percentile)', min=mins[['Employment (percentile)']], max= maxs[['Employment (percentile)']], value=c(mins[['Employment (percentile)']],maxs[['Employment (percentile)']]))
  updateSliderInput(session,inputId='Family and Social Support (percentile)', min=mins[['Family and Social Support (percentile)']], max= maxs[['Family and Social Support (percentile)']], value=c(mins[['Family and Social Support (percentile)']],maxs[['Family and Social Support (percentile)']]))
  updateSliderInput(session,inputId='Health behaviors (percentile)', min=mins[['Health behaviors (percentile)']], max= maxs[['Health behaviors (percentile)']], value=c(mins[['Health behaviors (percentile)']],maxs[['Health behaviors (percentile)']]))
  updateSliderInput(session,inputId='Health factors (percentile)', min=mins[['Health factors (percentile)']], max= maxs[['Health factors (percentile)']], value=c(mins[['Health factors (percentile)']],maxs[['Health factors (percentile)']]))
  updateSliderInput(session,inputId='Health outcomes (percentile)', min=mins[['Health outcomes (percentile)']], max= maxs[['Health outcomes (percentile)']], value=c(mins[['Health outcomes (percentile)']],maxs[['Health outcomes (percentile)']]))
  updateSliderInput(session,inputId='Housing and Transit (percentile)', min=mins[['Housing and Transit (percentile)']], max= maxs[['Housing and Transit (percentile)']], value=c(mins[['Housing and Transit (percentile)']],maxs[['Housing and Transit (percentile)']]))
  updateSliderInput(session,inputId='Income (percentile)', min=mins[['Income (percentile)']], max= maxs[['Income (percentile)']], value=c(mins[['Income (percentile)']],maxs[['Income (percentile)']]))
  updateSliderInput(session,inputId='Income Ratio', min=mins[['Income Ratio']], max= maxs[['Income Ratio']], value=c(mins[['Income Ratio']],maxs[['Income Ratio']]))
  updateSliderInput(session,inputId='Income Ratio (percentile)', min=mins[['Income Ratio (percentile)']], max= maxs[['Income Ratio (percentile)']], value=c(mins[['Income Ratio (percentile)']],maxs[['Income Ratio (percentile)']]))
  updateSliderInput(session,inputId='Length of Life (percentile)', min=mins[['Length of Life (percentile)']], max= maxs[['Length of Life (percentile)']], value=c(mins[['Length of Life (percentile)']],maxs[['Length of Life (percentile)']]))
  updateSliderInput(session,inputId='Physical environment (percentile)', min=mins[['Physical environment (percentile)']], max= maxs[['Physical environment (percentile)']], value=c(mins[['Physical environment (percentile)']],maxs[['Physical environment (percentile)']]))
  updateSliderInput(session,inputId='Quality of Care (percentile)', min=mins[['Quality of Care (percentile)']], max= maxs[['Quality of Care (percentile)']], value=c(mins[['Quality of Care (percentile)']],maxs[['Quality of Care (percentile)']]))
  updateSliderInput(session,inputId='Quality of Life (percentile)', min=mins[['Quality of Life (percentile)']], max= maxs[['Quality of Life (percentile)']], value=c(mins[['Quality of Life (percentile)']],maxs[['Quality of Life (percentile)']]))
  updateSliderInput(session,inputId='Sexual Activity (percentile)', min=mins[['Sexual Activity (percentile)']], max= maxs[['Sexual Activity (percentile)']], value=c(mins[['Sexual Activity (percentile)']],maxs[['Sexual Activity (percentile)']]))
  updateSliderInput(session,inputId='Social & economic factors (percentile)', min=mins[['Social & economic factors (percentile)']], max= maxs[['Social & economic factors (percentile)']], value=c(mins[['Social & economic factors (percentile)']],maxs[['Social & economic factors (percentile)']]))
  updateSliderInput(session,inputId='Tobacco Use (percentile)', min=mins[['Tobacco Use (percentile)']], max= maxs[['Tobacco Use (percentile)']], value=c(mins[['Tobacco Use (percentile)']],maxs[['Tobacco Use (percentile)']]))
  updateSliderInput(session,inputId='% 65 and Over', min=mins[['% 65 and Over']], max= maxs[['% 65 and Over']], value=c(mins[['% 65 and Over']],maxs[['% 65 and Over']]))
  updateSliderInput(session,inputId='% American Indian & Alaska Native', min=mins[['% American Indian & Alaska Native']], max= maxs[['% American Indian & Alaska Native']], value=c(mins[['% American Indian & Alaska Native']],maxs[['% American Indian & Alaska Native']]))
  updateSliderInput(session,inputId='% Asian', min=mins[['% Asian']], max= maxs[['% Asian']], value=c(mins[['% Asian']],maxs[['% Asian']]))
  updateSliderInput(session,inputId='% Black', min=mins[['% Black']], max= maxs[['% Black']], value=c(mins[['% Black']],maxs[['% Black']]))
  updateSliderInput(session,inputId='% Female', min=mins[['% Female']], max= maxs[['% Female']], value=c(mins[['% Female']],maxs[['% Female']]))
  updateSliderInput(session,inputId='% Hispanic', min=mins[['% Hispanic']], max= maxs[['% Hispanic']], value=c(mins[['% Hispanic']],maxs[['% Hispanic']]))
  updateSliderInput(session,inputId='% Less Than 18 Years of Age', min=mins[['% Less Than 18 Years of Age']], max= maxs[['% Less Than 18 Years of Age']], value=c(mins[['% Less Than 18 Years of Age']],maxs[['% Less Than 18 Years of Age']]))
  updateSliderInput(session,inputId='% Native Hawaiian/Other Pacific Islander', min=mins[['% Native Hawaiian/Other Pacific Islander']], max= maxs[['% Native Hawaiian/Other Pacific Islander']], value=c(mins[['% Native Hawaiian/Other Pacific Islander']],maxs[['% Native Hawaiian/Other Pacific Islander']]))
  updateSliderInput(session,inputId='% Non-Hispanic White', min=mins[['% Non-Hispanic White']], max= maxs[['% Non-Hispanic White']], value=c(mins[['% Non-Hispanic White']],maxs[['% Non-Hispanic White']]))
  updateSliderInput(session,inputId='% Rural', min=mins[['% Rural']], max= maxs[['% Rural']], value=c(mins[['% Rural']],maxs[['% Rural']]))
  updateSliderInput(session,inputId='Population', min=mins[['Population']], max= maxs[['Population']], value=c(mins[['Population']],maxs[['Population']]))
  updateSliderInput(session,inputId='Hospital overall rating', min=mins[['Hospital overall rating']], max= maxs[['Hospital overall rating']], value=c(mins[['Hospital overall rating']],maxs[['Hospital overall rating']]))
  updateSliderInput(session,inputId='MORT Better %', min=mins[['MORT Better %']], max= maxs[['MORT Better %']], value=c(mins[['MORT Better %']],maxs[['MORT Better %']]))
  updateSliderInput(session,inputId='MORT Worse %', min=mins[['MORT Worse %']], max= maxs[['MORT Worse %']], value=c(mins[['MORT Worse %']],maxs[['MORT Worse %']]))
  updateSliderInput(session,inputId='READM Better %', min=mins[['READM Better %']], max= maxs[['READM Better %']], value=c(mins[['READM Better %']],maxs[['READM Better %']]))
  updateSliderInput(session,inputId='READM Worse %', min=mins[['READM Worse %']], max= maxs[['READM Worse %']], value=c(mins[['READM Worse %']],maxs[['READM Worse %']]))
  updateSliderInput(session,inputId='Safety Better %', min=mins[['Safety Better %']], max= maxs[['Safety Better %']], value=c(mins[['Safety Better %']],maxs[['Safety Better %']]))
  updateSliderInput(session,inputId='Safety Worse %', min=mins[['Safety Worse %']], max= maxs[['Safety Worse %']], value=c(mins[['Safety Worse %']],maxs[['Safety Worse %']]))
  
})


# keep track of selections
`%notin%` <- Negate(`%in%`)

#initialize reactive vals
to_join <- reactiveVal(data.frame(ID = "", recommend_rank=0))
selectedID_list <- reactiveVal()
selectedIDs <- reactiveVal()
difficulty_counts <- reactiveVal(list("Reach" = 0,"Target" = 0, "Safer" = 0))
df_save <- reactiveVal()

# initialize global variables

hardcode_selectedIDs <- NULL

#log selections

observeEvent(input$table_row_last_clicked,{
  ID <- combined_df_list[[input$specialty]] %>%
    arrange(Overall_rank) %>%
    .[input$table_row_last_clicked,"ID"] %>%
    as.character(.)

  if (ID %notin% names(selectedID_list())) {
    lis_ <- selectedID_list()
    lis_[[ID]] <- 1
    selectedID_list(lis_)
  } else {
    lis_ <- selectedID_list()
    lis_[[ID]] <- lis_[[ID]] + 1
    selectedID_list(lis_)
  }

  newVal <- names(selectedID_list())[as.vector(unlist(lapply(selectedID_list(),function(i) mod(i,2)==1)))]
  selectedIDs(newVal)
  harcode_selectedIDs <<- selectedIDs()

  #make scoring calculations

  score <- c(input$step1, input$step2, input$research, input$publications, input$work, input$volunteer) %>%
    score_overall(., input$specialty, spec_dat,dists,PD_Survey_weights)
  safer <- pnorm(qnorm(score) - input$rangeset)
  reach <- pnorm(qnorm(score) + input$rangeset)

  combined_df_list[[input$specialty]] %>%
    mutate(Range = if_else(Overall_percentile > reach, "Reach", if_else(Overall_percentile > safer, "Target","Safer")), .before=1) %>%
    filter(ID %in% selectedIDs()) %>%
    dplyr::select(Range) %>%
    table(.) -> value_counts
  new_lis <- list("Reach" = 0,"Target" = 0, "Safer" = 0)
  for (name in c("Reach","Target","Safer")) {
    if (name %in% names(value_counts)) {
      new_lis[[name]] <- value_counts[[name]][[1]]
    }
  }
  difficulty_counts(new_lis)

  #prepare download helper
  data <- reactive({
    out <- df_save()
    out %>%
      filter(ID %in% selectedIDs())
  })
  output$downloadData <- downloadHandler(
    filename = function() {
      paste0(Sys.Date(), "_output.csv")
    },
    content = function(file) {
      vroom::vroom_write(data(), file, delim = ",")
    }
)
})

#reinitialize selections if specialty is switched or if bucketing cut-offs are updated
observeEvent(input$specialty,{
  selectedID_list(list())
  selectedIDs(c())
  difficulty_counts(list("Reach" = 0,"Target" = 0, "Safer" = 0))
})

observeEvent(input$rangeset,{
  selectedID_list(list())
  selectedIDs(c())
  difficulty_counts(list("Reach" = 0,"Target" = 0, "Safer" = 0))
})
```

### Reach program

```{r, context="server"}

output$valuebox_reach <- renderValueBox({
    valueBox(tags$p(difficulty_counts()[["Reach"]], style = "font-size: 150%; color: #fff"), caption = tags$p(paste0("target programs selected"), style = "font-size: 150%; color: #fff"), color = "info", href = NULL)
})
```

```{r, context="render"}
valueBoxOutput("valuebox_reach")
```

### Target program

```{r, context="server"}
output$valuebox_target <- renderValueBox({
    valueBox(tags$p(difficulty_counts()[["Target"]], style = "font-size: 150%; color: #fff"), caption = tags$p(paste0("target programs selected"),style = "font-size: 150%; color: #fff"), color = "warning", href = NULL)
})
```

```{r, context="render"}
valueBoxOutput("valuebox_target")
```

### Safer program

```{r, context="server"}
output$valuebox_safer <- renderValueBox({
    valueBox(tags$p(difficulty_counts()[["Safer"]], style = "font-size: 150%; color: #fff"), caption = tags$p(paste0("safer programs selected"),style = "font-size: 150%; color: #fff"), color = "success", href = NULL)
})
```

```{r, context="render"}
valueBoxOutput("valuebox_safer")
```

Row {data-height=900}
-----

###

```{r, context="server"}
observeEvent(input$button,{
  #join recommendations to the dataframe
  inter <- py$models[[input$specialty]]$recommend_from_interactions(observed_items=as.list(selectedIDs()),k=as.integer(1000))$to_dataframe()[,] %>%
    as.data.frame(.) %>%
    rename(recommend_rank = rank)
  to_join(inter)
})

output$table <- DT::renderDT({
  #make scoring calculations
  score <- c(input$step1, input$step2, input$research, input$publications, input$work, input$volunteer) %>%
    score_overall(., input$specialty, spec_dat,dists,PD_Survey_weights)
  safer <- pnorm(qnorm(score) - input$rangeset)
  reach <- pnorm(qnorm(score) + input$rangeset)

  #build core dataframe
  df <- combined_df_list[[input$specialty]] %>%
    arrange(Overall_rank) %>%
    mutate(Range = if_else(Overall_percentile > reach, "Reach", if_else(Overall_percentile > safer, "Target","Safer")), .before=1) %>%
    mutate(`Program website` = if_else(is.na(`Program website`),as.character(NA),paste0('<a style="font-size:100%" href="', `Program website`,'" target="_blank" class="btn btn-1">Link</a>'))) %>%
    mutate(`Freida` = if_else(is.na(`ID`),as.character(NA),paste0('<a style="font-size:100%" href="https://freida.ama-assn.org/program/', `ID`,'" target="_blank" class="btn btn-2">Link</a>'))) %>%
    mutate(`AAMC link` = if_else(is.na(`AAMC link`),as.character(NA),paste0('<a style="font-size:100%" href="', `AAMC link`,'" target="_blank" class="btn btn-3">Link</a>'))) %>%
    mutate(`Doximity link` = if_else(is.na(`Doximity link`),as.character(NA),paste0('<a style="font-size:100%" href="', `Doximity link`,'" target="_blank" class="btn btn-4">Link</a>'))) %>%
    relocate(City, .after=`Residency program name`)

  #filter core dataframe
  for (group in filter_groups) {
    vars_ <- filters %>%
      filter(Class == group) %>%
      dplyr::select(Colname) %>%
      .[[1]]
    for (var in vars_) {
      if (!is.null(classes[[var]])) {
        if (classes[[var]] %in% c("character","factor")) {
          df %<>%
            filter_at(vars(var), any_vars((. %in% input[[var]])))
          } else {
            df %<>%
              filter_at(vars(var), any_vars((. >= input[[var]][1] & . <= input[[var]][2])))
          }
      }
    }
  }

  # create and style DR
  val <- to_join()
  vis <- c("Range","Residency program name", "City", "State", "Overall rank","Program website","Freida","AAMC link","Doximity link", "# Residents on Duty Year 1","Range of average USMLE Step 1 score of current residents")
  df %<>%
    dplyr::select(.,-any_of(c("recommend_rank"))) %>%
    left_join(.,val,by="ID")  %>%
    relocate(any_of(vis))

  # create helper to move selected items to the top
  df$prev_select <- if_else(df$ID %in% isolate(selectedIDs()),c(TRUE),c(FALSE))

  # select previous rows
  selectedRows <- which(df$ID %in% isolate(selectedIDs()))

  # find columns to hide
  to_hide1 <- which(str_detect(colnames(df),"_1"))
  to_hide2 <- which(colnames(df) %in% c("score","recommend_rank","prev_select","Specialty"))
  to_hide3 <- which(str_detect(colnames(df),"_percentile"))

  # find colnames to color

  from_color <- colSums(is.na(df)) %>%
    .[.>0] %>%
    names(.) %>%
    .[!is.na(str_locate(.,"_1")[,1])]

  to_color <- from_color %>%
    str_sub(.,1,-3)

  # save df for downloading
  df_save(df)

  # prepare colname changes

  colname_change_list = list()
  colname_change_list[["Program website"]] <- "Program"
  colname_change_list[["AAMC link"]] <- "AAMC"
  colname_change_list[["Doximity link"]] <- "Doximity"
  colname_change_list[["# Residents on Duty Year 1"]] <- "# Year 1 Residents"
  colname_change_list[["Range of average USMLE Step 1 score of current residents"]] <- "Current residents Step 1 range"
  colname_change_vec <- as.numeric(lapply(names(colname_change_list), function(i) which(colnames(df) == i) + 1))
  names(colname_change_vec) <- as.character(colname_change_list)

  #adjust to_color for new column names
  replace_indices_base <- sapply( names(colname_change_list), function(i) which(to_color == i)) %>%
    as.numeric(.)
  replace_indices_non_na <- replace_indices_base %>%
    is.na(.) %>%
    as.numeric(.) %>%
    multiply_by(-1) %>%
    add(1) %>%
    as.logical(.) %>%
    which(.)
  to_color <- replace(to_color, replace_indices_base[replace_indices_non_na], as.character(colname_change_list)[replace_indices_non_na])

  # wrap column names and adjust variable names accordingly
  colnames(df) %<>% wrap_title
  to_color %<>% wrap_title
  from_color %<>% wrap_title
  names(colname_change_vec) %<>% wrap_title

  # mutate NAs and round numbers
  df %<>%
    mutate_at(vars(contains("_1")), ~as.numeric(is.na(.))) %>%
    mutate_if(is.numeric, ~round(.,2))

  # get full colnames
  colnames(df)

  # create datatable
  datatable(df, escape = F,
            colnames = colname_change_vec,
            options= list(autoWidth = TRUE,
                          pageLength = 10,
                          lengthMenu = c(6, 8, 10, 12),
                          columnDefs = list(list(visible=FALSE, targets=c(to_hide1,to_hide2,to_hide3))),
                          order = list(list(ncol(df),'desc'),list(ncol(df)-1,'asc')),
                          displayStart=floor(length(selectedRows)/10)*10,
                          scrollX = TRUE,
                          fixedColumns = list(leftColumns = 3)),
            extensions = 'FixedColumns',
            class = "display nowrap",
            selection = list(mode = "multiple", target = "row", selected = selectedRows)) %>%
    formatStyle(.,"Range", backgroundColor = styleEqual(c("Reach","Target","Safer"), c("#9954bb", "#ff7518","#3fb618")), color = styleEqual(c("Reach","Target","Safer"), c("#fff", "#fff","#fff"))) %>%
    formatStyle(.,columns = to_color,valueColumns = from_color,color = styleEqual(c(1),c("#ff0039"))) %>%
    formatStyle(.,columns = 1:ncol(df), fontSize = '100%')
  }
)
```

```{r, context="render"}
#output DT
DTOutput("table")
```

> Red text indicates values imputed through machine learning.

FAQ
===

### Frequently asked questions

<details>
<summary> How does the app determine your competitiveness score in the specialty?</summary>
<div>
In short, the app compares you to matched applicants in the specialty
you've chosen:

<ul>
<li>Your step 1 score</li>
<li>Your step 2 score</li>
<li>Your number of research experiences </li>
<li>Your number of publications </li>
<li>Your number of work experiences </li>
<li>Your number of volunteer experiences </li>
</ul>

Specifically, we compare your inputed scores and experiences to data provided by the AAMC on the [scores](https://www.aamc.org/data-reports/students-residents/interactive-data/report-residents/2020/table-b2-usmle-step-1-and-step-2-ck-scores-first-year-residents-specialty), and [experiences](https://www.aamc.org/data-reports/students-residents/interactive-data/report-residents/2020/table-b1-test-scores-and-experiences-first-year-residents-specialty) of matched applicants in your chosen specialty:

To come up with an aggregate score, we weight the six metrics above
based on [feedback provided by program
directors](https://mk0nrmp3oyqui6wqfm.kinstacdn.com/wp-content/uploads/2020/08/2020-PD-Survey.pdf)
on which factors matter most in selecting candidates to interview.

```{r, context="server"}
output$text1 <- renderText({
  paste0("For your chosen specialty of ", input$specialty,", the factors are weighted as follows:")
})
```

```{r, context="render"}
textOutput("text1")
```

```{r, context="server"}
output$kable_factors <- function() {
  req(input$specialty)
  PD_Survey_weights %>%
    filter(Specialty == input$specialty) %>%
    t() %>%
    as.data.frame(.) %>%
    janitor::row_to_names(.,1) %>%
    rename(Weights = 1) %>%
    mutate_at(1, as.numeric) %>%
    mutate_at(1, scales::percent) %>%
    kbl(.) %>%
    kable_styling(.)
}
```

```{r, context="render"}
tableOutput("kable_factors")
```
</div>
</details>

<details>
<summary>How does the app rank programs?</summary>
<div>
Program ranking is a bit more complicated. It's a weighted averaged of many factors. 30% of the ranking is tied to same six applicant competitive measures used to determine individual competitiveness. This is done by looking at the data each program provides on their respective residents. Note that programs don't provide data on Step 2 scores, so Step 1 scores are used as a proxy for both. 

The other 70% of the ranking is tied to remaining applicant characteristics, program selectivity, the quality of care at the hospital, research funding at the hospital, and teaching quality at the hospital, measured by board scores in common specialties. 

```{r, context="server"}
output$text2 <- renderText({
  paste0("For your chosen specialty of ", "Anesthesiology",", the factors are weighted as follows:")
})
```

```{r, context="render"}
textOutput("text2")
```

```{r, context="server"}
output$kable_factors2 <- function() {
  req(input$specialty)
  categories <- c(rep("Applicant competitiveness (core)",5),
                  rep("Applicant competitiveness (other)",3),
                  rep("Program selectivity",3),
                  rep("Care quality",7),
                  rep("Research quality",3),
                  rep("Teaching quality",5)
                  )
  ranking_weights %>% 
    filter(Specialty == "Anesthesiology") %>% 
    t() %>% 
    as.data.frame(.) %>% 
    janitor::row_to_names(.,1) %>% 
    rename(Weight = 1) %>% 
    mutate_at(1, as.numeric) %>%
    tibble::rownames_to_column(.,"Metric") %>% 
    mutate(Category = categories,.before=1) -> save
  
  save %>% 
    group_by(Category) %>% 
    summarize(`Total weight`=sum(Weight)) %>% 
    left_join(save,.) %>% 
    relocate(`Total weight`,.after=Category) %>% 
    mutate_at(vars(all_of(c("Total weight","Weight"))), ~scales::percent(., accuracy = 0.1)) %>% 
    kbl(.) %>% 
    kableExtra::collapse_rows(.,columns = 1:2, valign = 'middle') %>%
    kable_styling(.) 
}
```

```{r, context="render"}
tableOutput("kable_factors2")
```
</div>
</details>

<details>
<summary>How does the app determine whether a program is a Target, Reach, or Safer program?</summary>

```{r, context="server"}
output$text3 <- renderText({
  paste0("In short, it merges your own competitiveness with the school rankings above. Since both are ranked on a percentile scale between 0 and 1, a simple suggestion might be to set the Target range at ±x percentile of your competitiveness score. But this has a major flaw: there are many more successful applicants near the middle of the distribution. Because these applicants are more similar to each other, the Target range should be wider. Effectively, they look similar to other applicants at a larger portion of schools than at either end (low or high) of the distribution.\n\n","Instead, the app translates your competitiveness score and the school rankings in terms of the normal distibution. It arbitrarily considers any school with a rating within ±",input$rangeset, " standard deviations of your score to be in the Target range. Anything below is considered Safer and above is considered a Reach. You can adjust this setting below.\n\n")
})
```

```{r, context="render"}
textOutput("text3")
```

```{r, context="render"}
sliderInput("rangeset", "Target range set at ±x standard deviations",0,1,0.4)
```

```{r, context="server"}
output$text4 <- renderText({
  score <- c(input$step1, input$step2, input$research, input$publications, input$work, input$volunteer) %>%
    score_overall(., input$specialty, spec_dat,dists,PD_Survey_weights)
  safer <- pnorm(qnorm(score) - input$rangeset)
  reach <- pnorm(qnorm(score) + input$rangeset)
  paste0("For example, based on the information you've provided and your chosen specialty of ","Anesthesiology",", you rank at the ",scales::ordinal(100*score)," percentile in your specialty. As shown in the chart below, this sets your Target range for schools ranked between the ", scales::ordinal(100*safer), " percentile and the ", scales::ordinal(100*reach)," percentile. Anything above the ",scales::ordinal(100*reach), " is considerded a reach, and anything below the ",scales::ordinal(100*safer), " percentil is considered Safer.\n\n")
})
```


```{r, context="render"}
textOutput("text4")
```
<br>
If you prefer to think visually, the chart below indicates where you sit within the distribution:

```{r, context="server"}
output$gg <- renderPlotly({
  score <- c(input$step1, input$step2, input$research, input$publications, input$work, input$volunteer) %>%
    score_overall(., input$specialty, spec_dat,dists,PD_Survey_weights)
  safer <- qnorm(score) - input$rangeset
  reach <- qnorm(score) + input$rangeset
  actual <- qnorm(score)
  lbound <- min(-3,safer)
  ubound <- max(3, reach)
  ggplot(data = data.frame(x = c(lbound,ubound)), aes(x)) +
    stat_function(aes(fill = "Safer"), xlim = c(lbound, safer), fun = dnorm, n = 101, args = list(mean = 0, sd = 1), geom="area") +
    stat_function(aes(fill = "Target"), xlim = c(safer, reach), fun = dnorm, n = 101, args = list(mean = 0, sd = 1), geom="area") +
    stat_function(aes(fill = "Reach"), xlim = c(reach, ubound), fun = dnorm, n = 101, args = list(mean = 0, sd = 1), geom="area") +
    xlim(lbound-1, ubound+1) +
    ylab("") +
    xlab("Standard deviations from mean") +
    scale_fill_manual(values = c("#9954bb","#3fb618","#ff7518")) +
    geom_point(data=data.frame(x=actual,y=dnorm(actual)), aes(x=x, y=y), color="blue") + 
    geom_text(data=data.frame(x=actual,y=dnorm(actual)), aes(x=x, y=y, label=paste0("You: ",scales::ordinal(score*100), " percentile")), color="blue", nudge_x = if_else(actual>0,0.6,-0.6)) +
    geom_point(data=data.frame(x=safer,y=dnorm(safer)), aes(x=x, y=y), color="#3fb618") + 
    geom_text(data=data.frame(x=safer+if_else(safer>0,.1,-.1),y=dnorm(safer)), aes(x=x, y=y, label=paste0(scales::ordinal(pnorm(safer)*100), " percentile")), color="#3fb618", nudge_x = if_else(safer>0,0.45,-0.45)) +
    geom_point(data=data.frame(x=reach,y=dnorm(reach)), aes(x=x, y=y), color="#9954bb") + 
    geom_text(data=data.frame(x=reach+if_else(reach>0,.1,-.1),y=dnorm(reach)), aes(x=x, y=y, label=paste0(scales::ordinal(pnorm(reach)*100), " percentile")), color="#9954bb", nudge_x = if_else(reach>0,0.45,-0.45)) +
    guides(fill=guide_legend(title="Category")) +
    theme(axis.ticks.y = element_blank(), axis.text.y = element_blank()) -> gg 
ggplotly(gg)
})
```

```{r, context="render"}
plotlyOutput("gg")
```

</details>

<details>
<summary>How does the app handle missing information?</summary>

Data is missing from the app for two reasons:
<ul>
<li> Programs did not provide relevant info (e.g. step scores) to the AAMC </li>
<li> Auxiliary information (e.g. Medicare Hospital data) could not be joined to the underlying program data due to an inadequate match </li>
</ul>


```{r, context="server"}
output$text5 <- renderText({
  missing <- sum(is.na(dat_list[[input$specialty]]))
  total <- nrow(dat_list[[input$specialty]]) * (ncol(dat_list[[input$specialty]])-2) #subtract two due to name and ID
   paste0("Note that this is common, but not alarmingly so. In your chosen specialty of ",input$specialty," approximately ",scales::percent(missing/total), ". Unfortunately, this still presents a significant issue in ranking schools, since missing data would interfere with the ranking algorithm above. Fortunately, missing data is a well studied phenomenon. This app uses random forest imputation, a nonlinear machine learning algorithm, to help fill in the blanks. In the main program table on the \"Select programs\" tab, all imputed values are marked in red for transparency.")
})
```

```{r, context="render"}
textOutput("text5")
```
</details>

<details>
<summary>Where does your data come from?</summary>
<div>
```{r}
paste0("The app relies on ", nrow(bibliography)," main sources. The full list of sources can be found below:") %>% 
  tags$p(.)
```

```{r}
bibliography %>% 
  mutate(Link = paste0('<a style="font-size:100%" href="', Link,'" target="_blank" class="btn btn-1">Link</a>')) %>% 
  kbl(., escape = F) %>% 
  kable_styling(.)
```

Note that this data is under fair use only for non-commercial purposes, so please do not use commercially.

</div>
</details>

<details>
<summary>Why doesn't the app include all ERAS specialties?</summary>
<div>
```{r}
paste0("Unfortunately, the main data source for this app, AAMC residency explorer, only carries ",length(names(dat_list)), "specialties. This represents the vast majority of total programs, including all specialties with over 100 programs except Opthamology and Urology. The full list of included specialties below, along with the number of programs for each specialty.") %>% 
  tags$p(.)
```

```{r}
dat %>% 
  group_by(Specialty) %>% 
  summarize(`Total programs` = n())  %>% 
  kbl(.) %>% 
  kable_styling(.)
```
</div>
</details>

<details>
<summary>For the included specialties, are you missing any programs. If so, why? </summary>
<div>
```{r, context="server"}
output$text6 <- renderText({
  paste0("Even for the included specialties, AAMC residency explorer is not a complete dataset, or is very close. In total, it is missing ",nrow(missing_programs), ". In your chosen specialty, it is missing ",nrow(missing_programs %>% filter(Specialty == input$specialty)), ". Those programs are:")
})
```

```{r, context="render"}
textOutput("text6")
```

```{r, context="server"}
output$kable_missing <- function() {
  req(input$specialty)
  missing_programs %>% 
    filter(Specialty == input$specialty) %>% 
    kbl(.) %>% 
    kable_styling(.)
}
```
  
```{r, context="render"}
tableOutput("kable_missing")
```
</div>
</details>

<details>
<summary>Is the information I enter into the app private? </summary>

Yes, in the sense that no user or administrator will have access. No information will be saved across sessions. The downside of this is that once you leave the app, you'll lose your progress.

</details>

<details>
<summary>What should I do if I have more questions or I want to provide feedback? </summary>

Hit the envelope button on the top right of the page. It's a link to send me an email!
</details>

<details>
<summary>How can I support the site if I'd like to?  </summary>

Hit the coffee button on the top right of the page. It's a link to my "Buy me a coffee page". Any support you'd be willing to provide is much appreciated. It costs me ~$12 per month to keep up the Jupyterhub that hosts this site.
</details>
